# Jules Scheduled Tasks - API-Based Scheduler
#
# Uses GitHub Actions as a scheduler to trigger Jules API calls.
# The workflow spins up, creates a Jules session via API, and exits immediately.
# Jules executes tasks asynchronously in its cloud environment.
#
# Required Secrets:
#   JULES_API_KEY - API key from https://jules.google.com/settings#api
#                   (Uses your Google AI Pro subscription)
#
# Usage:
#   Prompts are stored in .jules/prompts/*.md
#   Each job reads a prompt and creates a session via API

name: Jules Scheduled Tasks

on:
  schedule:
    # === ALL TIMES ARE UTC (CST = UTC-6) ===
    # Schedule designed so all tasks complete before 8 AM CST
    #
    # DAILY (every day at 6:00 AM UTC / midnight CST)
    - cron: "0 6 * * *" # sentinel

    # WEEKLY (one task per day, 6:15 AM UTC / 12:15 AM CST)
    - cron: "15 6 * * 0" # Sunday: code_formatter
    - cron: "15 6 * * 1" # Monday: dependency_doctor
    - cron: "15 6 * * 2" # Tuesday: analytics_auditor
    - cron: "15 6 * * 3" # Wednesday: dead_code_scanner
    - cron: "15 6 * * 4" # Thursday: context7_librarian
    - cron: "30 6 * * 4" # Thursday: compliance_auditor (2nd task)
    - cron: "15 6 * * 5" # Friday: test_guardian
    - cron: "15 6 * * 6" # Saturday: context_sync

    # MONTHLY (1st of month at 6:45 AM UTC / 12:45 AM CST)
    - cron: "45 6 1 * *" # tool_version_auditor

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      task:
        description: "Task to run"
        required: true
        type: choice
        options:
          - sentinel
          - code_formatter
          - dependency_doctor
          - analytics_auditor
          - dead_code_scanner
          - context7_librarian
          - compliance_auditor
          - test_guardian
          - context_sync
          - tool_version_auditor
          - bolt

jobs:
  # Determine which task to run based on schedule or manual input
  determine-task:
    runs-on: ubuntu-latest
    outputs:
      task: ${{ steps.set-task.outputs.task }}
    steps:
      - name: Set task based on trigger
        id: set-task
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "task=${{ inputs.task }}" >> $GITHUB_OUTPUT
          else
            # Determine task from cron schedule
            HOUR=$(date -u +%H)
            MINUTE=$(date -u +%M)
            DAY=$(date -u +%u)      # 1=Monday, 7=Sunday
            DAY_OF_MONTH=$(date -u +%d)

            # Monthly task (1st of month at 6:45)
            if [ "$DAY_OF_MONTH" == "01" ] && [ "$HOUR" == "06" ] && [ "$MINUTE" -ge "45" ]; then
              echo "task=tool_version_auditor" >> $GITHUB_OUTPUT
            # Thursday has two tasks - check minute to differentiate
            elif [ "$DAY" == "4" ] && [ "$HOUR" == "06" ] && [ "$MINUTE" -ge "30" ]; then
              echo "task=compliance_auditor" >> $GITHUB_OUTPUT
            elif [ "$DAY" == "4" ] && [ "$HOUR" == "06" ] && [ "$MINUTE" -ge "15" ]; then
              echo "task=context7_librarian" >> $GITHUB_OUTPUT
            # Weekly tasks (6:15 AM UTC)
            elif [ "$DAY" == "7" ] && [ "$HOUR" == "06" ] && [ "$MINUTE" -ge "15" ]; then
              echo "task=code_formatter" >> $GITHUB_OUTPUT
            elif [ "$DAY" == "1" ] && [ "$HOUR" == "06" ] && [ "$MINUTE" -ge "15" ]; then
              echo "task=dependency_doctor" >> $GITHUB_OUTPUT
            elif [ "$DAY" == "2" ] && [ "$HOUR" == "06" ] && [ "$MINUTE" -ge "15" ]; then
              echo "task=analytics_auditor" >> $GITHUB_OUTPUT
            elif [ "$DAY" == "3" ] && [ "$HOUR" == "06" ] && [ "$MINUTE" -ge "15" ]; then
              echo "task=dead_code_scanner" >> $GITHUB_OUTPUT
            elif [ "$DAY" == "5" ] && [ "$HOUR" == "06" ] && [ "$MINUTE" -ge "15" ]; then
              echo "task=test_guardian" >> $GITHUB_OUTPUT
            elif [ "$DAY" == "6" ] && [ "$HOUR" == "06" ] && [ "$MINUTE" -ge "15" ]; then
              echo "task=context_sync" >> $GITHUB_OUTPUT
            else
              # Default: daily sentinel (6:00 AM UTC)
              echo "task=sentinel" >> $GITHUB_OUTPUT
            fi
          fi

  create-jules-session:
    needs: determine-task
    runs-on: ubuntu-latest
    timeout-minutes: 2 # API call is fast, fail quickly if issues

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read prompt file
        id: read-prompt
        run: |
          TASK="${{ needs.determine-task.outputs.task }}"
          PROMPT_FILE=".jules/prompts/${TASK}.md"

          if [ ! -f "$PROMPT_FILE" ]; then
            echo "Error: Prompt file not found: $PROMPT_FILE"
            exit 1
          fi

          # Read prompt content
          PROMPT=$(cat "$PROMPT_FILE")

          # Escape for JSON (replace newlines with \n, escape quotes)
          PROMPT_ESCAPED=$(echo "$PROMPT" | jq -Rs .)

          echo "prompt=$PROMPT_ESCAPED" >> $GITHUB_OUTPUT
          echo "Task: $TASK"
          echo "Prompt file: $PROMPT_FILE"

      - name: Get repository source name
        id: get-source
        run: |
          # Extract owner/repo from GitHub context
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          SOURCE="sources/github/${OWNER}/${REPO}"
          echo "source=$SOURCE" >> $GITHUB_OUTPUT
          echo "Source: $SOURCE"

      - name: Create Jules session via API
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          TASK="${{ needs.determine-task.outputs.task }}"
          SOURCE="${{ steps.get-source.outputs.source }}"
          PROMPT=${{ steps.read-prompt.outputs.prompt }}

          echo "ðŸš€ Creating Jules session: $TASK"

          # Create session via Jules API
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            'https://jules.googleapis.com/v1alpha/sessions' \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-Goog-Api-Key: $JULES_API_KEY" \
            -d "{
              \"prompt\": $PROMPT,
              \"sourceContext\": {
                \"source\": \"$SOURCE\",
                \"githubRepoContext\": {
                  \"startingBranch\": \"main\"
                }
              },
              \"automationMode\": \"AUTO_CREATE_PR\",
              \"title\": \"[Jules] $TASK - $(date +%Y-%m-%d)\"
            }")

          # Extract HTTP status code (last line)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Jules session created successfully"
            echo "Response: $BODY"
            
            # Extract session ID for logging
            SESSION_ID=$(echo "$BODY" | jq -r '.id // "unknown"')
            echo "Session ID: $SESSION_ID"
          else
            echo "âŒ Failed to create Jules session"
            echo "HTTP Status: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Log trigger summary
        run: |
          echo "## Jules Session Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Task:** ${{ needs.determine-task.outputs.task }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode:** AUTO_CREATE_PR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Jules will execute asynchronously and create a PR when complete." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check [Jules Dashboard](https://jules.google.com) for session status." >> $GITHUB_STEP_SUMMARY
