# Jules Scheduled Tasks - API-Based Scheduler
#
# Uses GitHub Actions as a scheduler to trigger Jules API calls.
# The workflow spins up, creates a Jules session via API, and exits immediately.
# Jules executes tasks asynchronously in its cloud environment.
#
# Required Secrets:
#   JULES_API_KEY - API key from https://jules.google.com/settings#api
#                   (Uses your Google AI Pro subscription)
#
# Usage:
#   Prompts are stored in .jules/prompts/*.md
#   Each job reads a prompt and creates a session via API

name: Jules Scheduled Tasks

on:
  schedule:
    # Security scan - Daily at 6 AM UTC
    - cron: "0 6 * * *"
    # Code formatting - Weekly on Sunday at 7 AM UTC
    - cron: "0 7 * * 0"
    # Dependency check - Weekly on Monday at 6 AM UTC
    - cron: "0 6 * * 1"
    # Dead code scan - Weekly on Wednesday at 6 AM UTC
    - cron: "0 6 * * 3"
    # Test coverage - Weekly on Friday at 6 AM UTC
    - cron: "0 6 * * 5"

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      task:
        description: "Task to run"
        required: true
        type: choice
        options:
          - sentinel
          - code_formatter
          - dependency_doctor
          - dead_code_scanner
          - test_guardian
          - compliance_auditor
          - context_sync
          - bolt

jobs:
  # Determine which task to run based on schedule or manual input
  determine-task:
    runs-on: ubuntu-latest
    outputs:
      task: ${{ steps.set-task.outputs.task }}
    steps:
      - name: Set task based on trigger
        id: set-task
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "task=${{ inputs.task }}" >> $GITHUB_OUTPUT
          else
            # Determine task from cron schedule
            HOUR=$(date -u +%H)
            DAY=$(date -u +%u)  # 1=Monday, 7=Sunday
            
            if [ "$DAY" == "7" ] && [ "$HOUR" == "07" ]; then
              echo "task=code_formatter" >> $GITHUB_OUTPUT
            elif [ "$DAY" == "1" ] && [ "$HOUR" == "06" ]; then
              echo "task=dependency_doctor" >> $GITHUB_OUTPUT
            elif [ "$DAY" == "3" ] && [ "$HOUR" == "06" ]; then
              echo "task=dead_code_scanner" >> $GITHUB_OUTPUT
            elif [ "$DAY" == "5" ] && [ "$HOUR" == "06" ]; then
              echo "task=test_guardian" >> $GITHUB_OUTPUT
            else
              # Default daily task
              echo "task=sentinel" >> $GITHUB_OUTPUT
            fi
          fi

  create-jules-session:
    needs: determine-task
    runs-on: ubuntu-latest
    timeout-minutes: 2 # API call is fast, fail quickly if issues

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read prompt file
        id: read-prompt
        run: |
          TASK="${{ needs.determine-task.outputs.task }}"
          PROMPT_FILE=".jules/prompts/${TASK}.md"

          if [ ! -f "$PROMPT_FILE" ]; then
            echo "Error: Prompt file not found: $PROMPT_FILE"
            exit 1
          fi

          # Read prompt content
          PROMPT=$(cat "$PROMPT_FILE")

          # Escape for JSON (replace newlines with \n, escape quotes)
          PROMPT_ESCAPED=$(echo "$PROMPT" | jq -Rs .)

          echo "prompt=$PROMPT_ESCAPED" >> $GITHUB_OUTPUT
          echo "Task: $TASK"
          echo "Prompt file: $PROMPT_FILE"

      - name: Get repository source name
        id: get-source
        run: |
          # Extract owner/repo from GitHub context
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          SOURCE="sources/github/${OWNER}/${REPO}"
          echo "source=$SOURCE" >> $GITHUB_OUTPUT
          echo "Source: $SOURCE"

      - name: Create Jules session via API
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          TASK="${{ needs.determine-task.outputs.task }}"
          SOURCE="${{ steps.get-source.outputs.source }}"
          PROMPT=${{ steps.read-prompt.outputs.prompt }}

          echo "ðŸš€ Creating Jules session: $TASK"

          # Create session via Jules API
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            'https://jules.googleapis.com/v1alpha/sessions' \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-Goog-Api-Key: $JULES_API_KEY" \
            -d "{
              \"prompt\": $PROMPT,
              \"sourceContext\": {
                \"source\": \"$SOURCE\",
                \"githubRepoContext\": {
                  \"startingBranch\": \"main\"
                }
              },
              \"automationMode\": \"AUTO_CREATE_PR\",
              \"title\": \"[Jules] $TASK - $(date +%Y-%m-%d)\"
            }")

          # Extract HTTP status code (last line)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Jules session created successfully"
            echo "Response: $BODY"
            
            # Extract session ID for logging
            SESSION_ID=$(echo "$BODY" | jq -r '.id // "unknown"')
            echo "Session ID: $SESSION_ID"
          else
            echo "âŒ Failed to create Jules session"
            echo "HTTP Status: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Log trigger summary
        run: |
          echo "## Jules Session Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Task:** ${{ needs.determine-task.outputs.task }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode:** AUTO_CREATE_PR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Jules will execute asynchronously and create a PR when complete." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check [Jules Dashboard](https://jules.google.com) for session status." >> $GITHUB_STEP_SUMMARY
